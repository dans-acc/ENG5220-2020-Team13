<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BeeSafe Project: Location-management</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../beeSmall.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BeeSafe Project
   &#160;<span id="projectnumber">v1.0</span>
   </div>
   <div id="projectbrief">Low-cost tracking device.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d9/d1b/md_doc_wiki__location-management.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Location-management </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This page highlights the structure employed for defining virtual fences.</p>
<h1>Fences</h1>
<p>Fences are defined according to the following hierarchical structure:</p>
<div class="image">
<img src="https://github.com/itsBelinda/ENG5220-2020-Team13/blob/master/doc/media/Fence_Structure.png" alt="Fence, RoundFence and PolyFence structure."/>
</div>
<p>This was done due to each device account possessing numerous virtual fences. With respect to the implementations:</p>
<ul>
<li><a class="el" href="../../d6/d78/_fence_8h.html">Fence.h</a> / .cpp defines common attributes i.e. whether the fence is regarded as being safe (the device can be removed), times, and the name.</li>
<li><a class="el" href="../../df/d09/_round_fence_8h.html">RoundFence.h</a> / .cpp defines a circular virtual fence around a centre point (latitude, longitude and radius). It does not however take into account the curvature of Earth.</li>
<li><a class="el" href="../../d6/dce/_poly_fence_8h.html">PolyFence.h</a> / .cpp defines polygon fences with numerous points. The implementation is based on the work published on <a href="http://alienryderflex.com/polygon/?fbclid=IwAR1iLUkzQZnRRCWvPyUjvrYXU6W259FduDmq8NhDPSHMaUAtOmUnE_HEoAA">Determining Whether A Point Is Inside A Complex Polygon</a> - which, once again, does not consider the curvature of the Earth.</li>
</ul>
<p>Each instance is responsible for serialising JSON elements that represent the fence (sub-classes), first invoke the super-class serialisation then build on this in the extended (overridden) functions. However, they are created using the <a href="https://github.com/itsBelinda/ENG5220-2020-Team13/wiki/Account-Management">AccountBuilder</a>.</p>
<p><b>It should be noted that not taking the curvature into consideration only affects extremely large fences (areas larger than Texas).</b></p>
<h2><a class="el" href="../../d6/d78/_fence_8h.html">Fence.h</a> / .cpp</h2>
<p>Not only does the <a class="el" href="../../d0/db8/class_fence.html" title="The Fence parent class providing generic functionality for handling fences. ">Fence</a> super-class define common attributes, but it also handles common operations such as determining whether the device needs to be present in the fence at a given time.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="../../d0/db8/class_fence.html#a7695b0f94f461369703188a287a38ab4">Fence::isInTime</a>(<span class="keyword">const</span> std::time_t &amp;time) {</div><div class="line"></div><div class="line">    <span class="comment">// Extract information from system time.</span></div><div class="line">    std::tm time_tm = *std::localtime(&amp;time);</div><div class="line">    <span class="keyword">auto</span> iter = <a class="code" href="../../d0/db8/class_fence.html#ae589e973fa03316847aeceedd72e2b64">week</a>.find(time_tm.tm_wday);</div><div class="line"></div><div class="line">    <span class="comment">// Check if time information exists.</span></div><div class="line">    <span class="keywordflow">if</span> (iter == <a class="code" href="../../d0/db8/class_fence.html#ae589e973fa03316847aeceedd72e2b64">week</a>.end()) {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iter-&gt;second.empty()) {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Iterate through days list of from and to times.</span></div><div class="line">    <span class="keyword">auto</span> &amp;dayTimes = iter-&gt;second;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> std::pair&lt;std::tm, std::tm&gt; &amp;dayTime : dayTimes) {</div><div class="line"></div><div class="line">        <span class="comment">// If time is before from time, we are not present.</span></div><div class="line">        <span class="keywordflow">if</span> (time_tm.tm_hour &lt; dayTime.first.tm_hour) {</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (time_tm.tm_hour == dayTime.first.tm_hour) {</div><div class="line">            <span class="keywordflow">if</span> (time_tm.tm_min &lt; dayTime.first.tm_min) {</div><div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// If the time is after the to time, we are not present.</span></div><div class="line">        <span class="keywordflow">if</span> (time_tm.tm_hour &gt; dayTime.second.tm_hour) {</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (time_tm.tm_hour == dayTime.second.tm_hour) {</div><div class="line">            <span class="keywordflow">if</span> (time_tm.tm_min &gt; dayTime.second.tm_min) {</div><div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// By default the user is within the fence.</span></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div></div><!-- fragment --><p> This is achieved by comparing the current time of the device (using <code>*std::localtime(&amp;time);</code>) against the serialised times represented by the <code>const std::map&lt;int, std::vector&lt;std::pair&lt;std::tm, std::tm&gt;&gt;&gt; &amp;week</code>, where a day (the map key) maps onto a vector containing the starting and ending times (<code>std::pair&lt;std::tm, std::tm&gt;</code>). Moreover, in the event the said <a class="el" href="../../d0/db8/class_fence.html" title="The Fence parent class providing generic functionality for handling fences. ">Fence</a> map is empty, the function returns true (indicating that the device is indeed present in the fence at that particular time).</p>
<h2><a class="el" href="../../df/d09/_round_fence_8h.html">RoundFence.h</a> / .cpp</h2>
<p>As stated, the round fence represents the fence defined around some coordinate (latitude, longitude). Thus, a determining whether the device is geographically located within can be achieved using simple geometry:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="../../da/d8b/class_round_fence.html#a4955bf0dbd168853ba9913465953865d">RoundFence::isInLocation</a>(std::pair&lt;double, double&gt; &amp;latLng)</div><div class="line">{</div><div class="line">    <span class="keywordtype">double</span> distance = std::sqrt((latLng.first - this-&gt;longitude) * (latLng.first - this-&gt;latitude)</div><div class="line">                                + (latLng.second - this-&gt;longitude) * (latLng.second - this-&gt;longitude));</div><div class="line">    <span class="keywordflow">return</span> distance &lt;= <a class="code" href="../../da/d8b/class_round_fence.html#a8e9d1a2f22df0bb718522f3ab6cd3b83">radius</a>;</div><div class="line">}</div></div><!-- fragment --><p> Where the <code>std::pair&lt;double, double&gt; &amp;latLng</code> represents the device coordinates (<code>latLng.first</code> and <code>latLng.second</code> represent the latitude and longitude, respectively); passed by the <a class="el" href="../../dd/d29/_monitor_8h.html">Monitor.h</a> / <a class="el" href="../../dd/d8c/_monitor_8cpp.html">Monitor.cpp</a> (monitor thread).</p>
<h2><a class="el" href="../../d6/dce/_poly_fence_8h.html">PolyFence.h</a> / .cpp</h2>
<p>Finally, polygon fences are represented using a vector of pairs i.e. <code>std::vector&lt;std::pair&lt;double, double&gt;&gt; coordinates</code>; where each pair represents coordinates as follows:</p><ul>
<li><code>latLng.first</code> and <code>latLng.second</code> represent the latitude and longitude, respectively.</li>
</ul>
<h3>Implementation</h3>
<p>With respect to the implementation of the algorithm as posited on <a href="http://alienryderflex.com/polygon/?fbclid=IwAR1iLUkzQZnRRCWvPyUjvrYXU6W259FduDmq8NhDPSHMaUAtOmUnE_HEoAA">Determining Whether A Point Is Inside A Complex Polygon</a>, suggested optimisations have been taken into account. Thus, constants associated with the fence are calculated prior to monitoring being carried out i.e. during the initialisation phase of the device. The following code snippet posits the manner by which this is achieved:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="../../d1/d22/class_poly_fence.html#a229de6f5987bf7d312310b522db0d5a4">PolyFence::calculateFenceConstants</a>()</div><div class="line">{</div><div class="line"></div><div class="line">    <span class="comment">// Clear the constants for recalculation.</span></div><div class="line">    <a class="code" href="../../d1/d22/class_poly_fence.html#a24c99bb8a45f86bdf51cd3f22ef0f174">constants</a>.clear();</div><div class="line">    <a class="code" href="../../d1/d22/class_poly_fence.html#a2204e62b61b0e3c335734fa0b6cf0728">multiples</a>.clear();</div><div class="line"></div><div class="line">    <span class="comment">// If the coordinates are empty, nothing can be done.</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>.empty()) {</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Calculate poly fence constants.</span></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i, j = <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>.size() - 1;</div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>.size(); ++i) {</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].second == <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[j].second) {</div><div class="line">            <a class="code" href="../../d1/d22/class_poly_fence.html#a24c99bb8a45f86bdf51cd3f22ef0f174">constants</a>.push_back(<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].first);</div><div class="line">            <a class="code" href="../../d1/d22/class_poly_fence.html#a2204e62b61b0e3c335734fa0b6cf0728">multiples</a>.push_back(0);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            <a class="code" href="../../d1/d22/class_poly_fence.html#a24c99bb8a45f86bdf51cd3f22ef0f174">constants</a>.push_back(<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].first</div><div class="line">                                - (<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].second * <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[j].first)</div><div class="line">                                  / (<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[j].second - <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].second)</div><div class="line">                                + (<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].second * <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].first)</div><div class="line">                                  / (<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[j].second - <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].second));</div><div class="line">            <a class="code" href="../../d1/d22/class_poly_fence.html#a2204e62b61b0e3c335734fa0b6cf0728">multiples</a>.push_back((<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[j].first - <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].first)</div><div class="line">                                / (<a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[j].second - <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].second));</div><div class="line">        }</div><div class="line">        j = i;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> Where determining whether or not the device is within the polygon fence is achieved by utilising the following function, analogous to the one posited by <a class="el" href="../../df/d09/_round_fence_8h.html">RoundFence.h</a> / .cpp:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="../../d1/d22/class_poly_fence.html#af8116af5be86f8426102985c3dbcdf5e">PolyFence::isInLocation</a>(std::pair&lt;double, double&gt; &amp;latLng)</div><div class="line">{</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> oddNodes = <span class="keyword">false</span>;</div><div class="line">    <span class="keywordtype">bool</span> current = <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>.back().second &gt; latLng.second;</div><div class="line">    <span class="keywordtype">bool</span> previous;</div><div class="line"></div><div class="line">    <span class="comment">// Determines whether or not latitude and longitude are within the fence.</span></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>.size(); ++i) {</div><div class="line">        previous = current;</div><div class="line">        current = <a class="code" href="../../d1/d22/class_poly_fence.html#ae8e0c55e745979cab104ef80aeb4b418">coordinates</a>[i].second &gt; latLng.second;</div><div class="line">        <span class="keywordflow">if</span> (current != previous) {</div><div class="line">            oddNodes ^= latLng.second * <a class="code" href="../../d1/d22/class_poly_fence.html#a2204e62b61b0e3c335734fa0b6cf0728">multiples</a>[i] + <a class="code" href="../../d1/d22/class_poly_fence.html#a24c99bb8a45f86bdf51cd3f22ef0f174">constants</a>[i] &lt; latLng.first;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> oddNodes;</div></div><!-- fragment --><p> Functionally, the algorithm compares each side of the polygon against the longitude of the device location. Additionally, a list of nodes are compiled, where each of the nodes represent a point where one side crosses the longitude threshold of the device location. Thus,</p>
<ul>
<li>If there are an odd number of points (on each side of the location), then device is said to be within the polygon.</li>
<li>If, however, there are an even number of nodes, the device location is outside of the polygon.</li>
</ul>
<p><b>Reference:</b> <a href="http://alienryderflex.com/polygon/?fbclid=IwAR1iLUkzQZnRRCWvPyUjvrYXU6W259FduDmq8NhDPSHMaUAtOmUnE_HEoAA">Determining Whether A Point Is Inside A Complex Polygon</a></p>
<h2>Displaying Virtual Fences</h2>
<p><em>The following image depicts the defined virtual fences. It should be noted that due to time constraints, the web API backend was not implemented. Thus, the project falls just short of being completed due to the backend missing link for the website [frontend is present and is depicted by the following image].</em> </p><div class="image">
<img src="https://github.com/itsBelinda/ENG5220-2020-Team13/blob/master/doc/media/Fences.png" alt="Defined virtual fences"/>
</div>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
